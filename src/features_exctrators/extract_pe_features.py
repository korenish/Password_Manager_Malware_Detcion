import pefile
import lief

from features_exctrators import SUSPICIOUS_FUNCTIONS_INPUT


class ExtractFeaturesFromSamplePE:
    def __init__(self, sample_sha256, sample_path):
        self.sample_pe = pefile.PE(sample_path)
        self.lief_pe = lief.parse(sample_path)
        self.sample_sha256 = sample_sha256

        # Initialize default value features
        self.pe_features = {
            'imphash': None,
            'rich_header': None,
            'dll_imports': [],
            'sus_import_functions': [],
            'export_functions': []
        }

    def extract(self):
        self.pe_features['imphash'], self.pe_features['rich_header'] = self.extract_basic_pe_info()
        self.pe_features['dll_imports'] = self.extract_pe_import_dlls()
        self.pe_features['sus_import_functions'] = self.extract_sus_import_functions()
        self.pe_features['export_functions'] = self.extract_export_functions()

        return self.pe_features

    def extract_basic_pe_info(self):
        if self.sample_pe.parse_rich_header():
            return self.sample_pe.get_imphash(), self.sample_pe.parse_rich_header()['key']

        return self.sample_pe.get_imphash(), None

    def extract_pe_import_dlls(self):
        dll_libraries = []

        for crr_import_library in self.sample_pe.DIRECTORY_ENTRY_IMPORT:
            curr_library_name = crr_import_library.dll.decode("utf-8")
            dll_libraries.append(curr_library_name)

        return dll_libraries

    def extract_sus_import_functions(self):
        imported_sus_functions = []

        if self.lief_pe.has_imports:
            for imported_library in self.lief_pe.imports:
                for func in imported_library.entries:
                    if func.name in SUSPICIOUS_FUNCTIONS_INPUT:
                        imported_sus_functions.append(func.name)

        return imported_sus_functions

    def extract_export_functions(self):
        export_functions = []

        if self.lief_pe.has_exports:
            for exported_library in self.lief_pe.exports:
                for func in exported_library.entries:
                    export_functions.append(func.name)

        return export_functions

