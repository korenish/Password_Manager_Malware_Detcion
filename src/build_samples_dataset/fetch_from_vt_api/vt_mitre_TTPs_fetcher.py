import pickle
import time

import requests

ACCEPT_ENCODINGS = "gzip, deflate"
USER_AGENT = "vtscan v.1.0"

VT_API_KEYS = ["cc084a7946361d7a6a0d8aeb971591b2aec13f5f731883027305ccdf63fbd832",
               "71fd05c1b79164c2feb763cbecfe4fe6f84348b2e6ba1f1c21cdb42a6db96eab",
               "2cf3d4d1536fdfae247c508b4255e60e9b0b72e32a193a5168130c37d4dfecfd",
               "94a22a610ea04217b4532a1d450b99050c7e077c30302be3523d1b1e0bfd29a1",
               "38a659c404aa67523862b38898ff7405f7827d1494a36f609e7dad87264275a8",
               "1d76bdf99eb62147da2698ec8b8e7f5bd4641c99e96e73b0b68343b9ee795084",
               "32877db190488485584beace9d013d479b627c0badb487a2cbbc00f36774452f"]

VT_BASE_URL = "https://www.virustotal.com/api/v3/files/"

REQUESTS_PER_MINUTE_PER_KEY = 3


def run_single_request_mitre_ttps(sha256, api_key):
    mitre_ttps_url = VT_BASE_URL + f"{sha256}/behaviour_mitre_trees"
    headers = {
        "x-apikey": api_key,
        "User-Agent": USER_AGENT,
        "Accept-Encoding": ACCEPT_ENCODINGS
    }
    try:
        res = requests.get(mitre_ttps_url, headers=headers)
    except:
        print("failed to get info, cannot send API req :(")
    else:
        if res.status_code == 200:
            try:
                result = res.json()
                return result.get("data")
            except:
                print("Sha without Mitre signatures detected, ignoring")
        else:
            print(f"failed to get results of analysis - status code: {str(res.status_code)}")


def process_and_append(sha256, mitre_ttps, result_obj):
    extracted_tactics = set(())
    extracted_techniques = set(())

    for sand_box in mitre_ttps.keys():
        tactics = mitre_ttps[sand_box]["tactics"]
        if tactics:
            for tactic in tactics:
                extracted_tactics.add(tactic["id"])
                techniques = tactic["techniques"]
                if techniques:
                    for technique in techniques:
                        extracted_techniques.add(technique["id"])
    append_to_result(result_obj, sha256, extracted_tactics, extracted_techniques)

    print(
        f"Done processing sha {sha256}, found {len(extracted_tactics)} tactics and {len(extracted_techniques)} techniques")


def append_to_result(result_obj, sha256, extracted_tactics_set, extracted_techniques_set):
    result_obj["SHAS"].append({"sha256": sha256,
                               "tactics": list(extracted_tactics_set),
                               "techniques": list(extracted_techniques_set)})


def sleep_if_needed(curr_api_key_index):
    if curr_api_key_index == 0:
        print(f"Sleeping {str(60 / REQUESTS_PER_MINUTE_PER_KEY)} seconds!")
        time.sleep(60 / REQUESTS_PER_MINUTE_PER_KEY)


def fetch_and_save_data_from_vt(all_samples_sha256: list):
    result_obj = {"SHAS": []}
    curr_api_key_index = 0

    for sha256 in all_samples_sha256:
        curr_api_key = VT_API_KEYS[curr_api_key_index]
        mitre_ttps = run_single_request_mitre_ttps(sha256, curr_api_key)

        if mitre_ttps is not None:
            process_and_append(sha256, mitre_ttps, result_obj)
        curr_api_key_index = (curr_api_key_index + 1) % len(VT_API_KEYS)
        sleep_if_needed(curr_api_key_index)

    return result_obj
