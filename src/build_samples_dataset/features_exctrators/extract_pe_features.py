import lief

from build_samples_dataset.features_exctrators import SUSPICIOUS_FUNCTIONS_INPUT


class ExtractFeaturesFromSamplePE:
    def __init__(self, sample_sha256, sample_path):
        self.lief_pe = lief.parse(sample_path)
        self.sample_sha256 = sample_sha256

        # Initialize default value features
        self.pe_features = {
            'pe_dll_imports': [],
            'pe_sus_import_functions': []
        }

    def extract(self):
        self.pe_features['pe_dll_imports'] = self.extract_import_dlls()
        self.pe_features['pe_sus_import_functions'] = self.extract_sus_import_functions()

        return self.pe_features

    def extract_import_dlls(self):
        dll_libraries = []

        if self.lief_pe.has_imports:
            for imported_library in self.lief_pe.imports:
                curr_library_name = imported_library.name.lower()
                dll_libraries.append(curr_library_name)

        return dll_libraries

    def extract_sus_import_functions(self):
        imported_sus_functions = []

        if self.lief_pe.has_imports:
            for imported_library in self.lief_pe.imports:
                for func in imported_library.entries:
                    if func.name in SUSPICIOUS_FUNCTIONS_INPUT:
                        imported_sus_functions.append(func.name)

        return imported_sus_functions

    def extract_export_functions(self):
        export_functions = []

        if self.lief_pe.has_exports:
            for exported_library in self.lief_pe.exports:
                for func in exported_library.entries:
                    export_functions.append(func.name)

        return export_functions

